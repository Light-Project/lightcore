/* SPDX-License-Identifier: GPL-2.0-or-later */
/*
 * Copyright(c) 2022 John Sanpe <sanpeqf@gmail.com>
 */

#include <initcall.h>
#include <kshell.h>
#include <asm/regs.h>

struct cpuid_entry {
    const char *name;
    uint64_t value;
};

#define CPUID_ENTRY(cpuid) \
    {#cpuid, X86_CPUID_##cpuid}

static const struct cpuid_entry cpuid_table[] = {
    CPUID_ENTRY(FPU),
    CPUID_ENTRY(VME),
    CPUID_ENTRY(DE),
    CPUID_ENTRY(PSE),
    CPUID_ENTRY(TSC),
    CPUID_ENTRY(MSR),
    CPUID_ENTRY(PAE),
    CPUID_ENTRY(MCE),
    CPUID_ENTRY(CX8),
    CPUID_ENTRY(APIC),
    CPUID_ENTRY(SEP),
    CPUID_ENTRY(MTRR),
    CPUID_ENTRY(PGE),
    CPUID_ENTRY(MCA),
    CPUID_ENTRY(CMOV),
    CPUID_ENTRY(PAT),
    CPUID_ENTRY(PSE36),
    CPUID_ENTRY(PN),
    CPUID_ENTRY(CLFLUSH),
    CPUID_ENTRY(DS),
    CPUID_ENTRY(ACPI),
    CPUID_ENTRY(MMX),
    CPUID_ENTRY(FXSR),
    CPUID_ENTRY(XMM),
    CPUID_ENTRY(XMM2),
    CPUID_ENTRY(SELFSNOOP),
    CPUID_ENTRY(HT),
    CPUID_ENTRY(ACC),
    CPUID_ENTRY(IA64),
    CPUID_ENTRY(PBE),
    CPUID_ENTRY(SYSCALL),
    CPUID_ENTRY(MP),
    CPUID_ENTRY(NX),
    CPUID_ENTRY(MMXEXT),
    CPUID_ENTRY(FXSR_OPT),
    CPUID_ENTRY(GBPAGES),
    CPUID_ENTRY(RDTSCP),
    CPUID_ENTRY(LM),
    CPUID_ENTRY(3DNOWEXT),
    CPUID_ENTRY(3DNOW),
    CPUID_ENTRY(RECOVERY),
    CPUID_ENTRY(LONGRUN),
    CPUID_ENTRY(LRTI),
    CPUID_ENTRY(CXMMX),
    CPUID_ENTRY(K6_MTRR),
    CPUID_ENTRY(CYRIX_ARR),
    CPUID_ENTRY(CENTAUR_MCR),
    CPUID_ENTRY(K8),
    CPUID_ENTRY(P3),
    CPUID_ENTRY(P4),
    CPUID_ENTRY(CONSTANT_TSC),
    CPUID_ENTRY(UP),
    CPUID_ENTRY(ART),
    CPUID_ENTRY(ARCH_PERFMON),
    CPUID_ENTRY(PEBS),
    CPUID_ENTRY(BTS),
    CPUID_ENTRY(SYSCALL32),
    CPUID_ENTRY(SYSENTER32),
    CPUID_ENTRY(REP_GOOD),
    CPUID_ENTRY(LFENCE_RDTSC),
    CPUID_ENTRY(ACC_POWER),
    CPUID_ENTRY(NOPL),
    CPUID_ENTRY(ALWAYS),
    CPUID_ENTRY(XTOPOLOGY),
    CPUID_ENTRY(TSC_RELIABLE),
    CPUID_ENTRY(NONSTOP_TSC),
    CPUID_ENTRY(CPUID),
    CPUID_ENTRY(EXTD_APICID),
    CPUID_ENTRY(AMD_DCM),
    CPUID_ENTRY(APERFMPERF),
    CPUID_ENTRY(RAPL),
    CPUID_ENTRY(NONSTOP_TSC_S3),
    CPUID_ENTRY(TSC_KNOWN_FREQ),
    CPUID_ENTRY(XMM3),
    CPUID_ENTRY(PCLMULQDQ),
    CPUID_ENTRY(DTES64),
    CPUID_ENTRY(MWAIT),
    CPUID_ENTRY(DSCPL),
    CPUID_ENTRY(VMX),
    CPUID_ENTRY(SMX),
    CPUID_ENTRY(EST),
    CPUID_ENTRY(TM2),
    CPUID_ENTRY(SSSE3),
    CPUID_ENTRY(CID),
    CPUID_ENTRY(SDBG),
    CPUID_ENTRY(FMA),
    CPUID_ENTRY(CX16),
    CPUID_ENTRY(XTPR),
    CPUID_ENTRY(PDCM),
    CPUID_ENTRY(PCID),
    CPUID_ENTRY(DCA),
    CPUID_ENTRY(XMM4_1),
    CPUID_ENTRY(XMM4_2),
    CPUID_ENTRY(X2APIC),
    CPUID_ENTRY(MOVBE),
    CPUID_ENTRY(POPCNT),
    CPUID_ENTRY(TSC_DEADLINE_TIMER),
    CPUID_ENTRY(AES),
    CPUID_ENTRY(XSAVE),
    CPUID_ENTRY(OSXSAVE),
    CPUID_ENTRY(AVX),
    CPUID_ENTRY(F16C),
    CPUID_ENTRY(RDRAND),
    CPUID_ENTRY(HYPERVISOR),
    CPUID_ENTRY(XSTORE),
    CPUID_ENTRY(XSTORE_EN),
    CPUID_ENTRY(XCRYPT),
    CPUID_ENTRY(XCRYPT_EN),
    CPUID_ENTRY(ACE2),
    CPUID_ENTRY(ACE2_EN),
    CPUID_ENTRY(PHE),
    CPUID_ENTRY(PHE_EN),
    CPUID_ENTRY(PMM),
    CPUID_ENTRY(PMM_EN),
    CPUID_ENTRY(LAHF_LM),
    CPUID_ENTRY(CMP_LEGACY),
    CPUID_ENTRY(SVM),
    CPUID_ENTRY(EXTAPIC),
    CPUID_ENTRY(CR8_LEGACY),
    CPUID_ENTRY(ABM),
    CPUID_ENTRY(SSE4A),
    CPUID_ENTRY(MISALIGNSSE),
    CPUID_ENTRY(3DNOWPREFETCH),
    CPUID_ENTRY(OSVW),
    CPUID_ENTRY(IBS),
    CPUID_ENTRY(XOP),
    CPUID_ENTRY(SKINIT),
    CPUID_ENTRY(WDT),
    CPUID_ENTRY(LWP),
    CPUID_ENTRY(FMA4),
    CPUID_ENTRY(TCE),
    CPUID_ENTRY(NODEID_MSR),
    CPUID_ENTRY(TBM),
    CPUID_ENTRY(TOPOEXT),
    CPUID_ENTRY(PERFCTR_CORE),
    CPUID_ENTRY(PERFCTR_NB),
    CPUID_ENTRY(BPEXT),
    CPUID_ENTRY(PTSC),
    CPUID_ENTRY(PERFCTR_LLC),
    CPUID_ENTRY(MWAITX),
    CPUID_ENTRY(RING3MWAIT),
    CPUID_ENTRY(CPUID_FAULT),
    CPUID_ENTRY(CPB),
    CPUID_ENTRY(EPB),
    CPUID_ENTRY(CAT_L3),
    CPUID_ENTRY(CAT_L2),
    CPUID_ENTRY(CDP_L3),
    CPUID_ENTRY(INVPCID_SINGLE),
    CPUID_ENTRY(HW_PSTATE),
    CPUID_ENTRY(PROC_FEEDBACK),
    CPUID_ENTRY(PTI),
    CPUID_ENTRY(RETPOLINE),
    CPUID_ENTRY(RETPOLINE_AMD),
    CPUID_ENTRY(INTEL_PPIN),
    CPUID_ENTRY(CDP_L2),
    CPUID_ENTRY(MSR_SPEC_CTRL),
    CPUID_ENTRY(SSBD),
    CPUID_ENTRY(MBA),
    CPUID_ENTRY(RSB_CTXSW),
    CPUID_ENTRY(USE_IBPB),
    CPUID_ENTRY(USE_IBRS_FW),
    CPUID_ENTRY(SPEC_STORE_BYPASS_DISABLE),
    CPUID_ENTRY(LS_CFG_SSBD),
    CPUID_ENTRY(IBRS),
    CPUID_ENTRY(IBPB),
    CPUID_ENTRY(STIBP),
    CPUID_ENTRY(ZEN),
    CPUID_ENTRY(L1TF_PTEINV),
    CPUID_ENTRY(IBRS_ENHANCED),
    CPUID_ENTRY(MSR_IA32_FEAT_CTL),
    CPUID_ENTRY(TPR_SHADOW),
    CPUID_ENTRY(VNMI),
    CPUID_ENTRY(FLEXPRIORITY),
    CPUID_ENTRY(EPT),
    CPUID_ENTRY(VPID),
    CPUID_ENTRY(VMMCALL),
    CPUID_ENTRY(XENPV),
    CPUID_ENTRY(EPT_AD),
    CPUID_ENTRY(VMCALL),
    CPUID_ENTRY(VMW_VMMCALL),
    CPUID_ENTRY(PVUNLOCK),
    CPUID_ENTRY(VCPUPREEMPT),
    CPUID_ENTRY(FSGSBASE),
    CPUID_ENTRY(TSC_ADJUST),
    CPUID_ENTRY(SGX),
    CPUID_ENTRY(BMI1),
    CPUID_ENTRY(HLE),
    CPUID_ENTRY(AVX2),
    CPUID_ENTRY(FDP_EXCPTN_ONLY),
    CPUID_ENTRY(SMEP),
    CPUID_ENTRY(BMI2),
    CPUID_ENTRY(ERMS),
    CPUID_ENTRY(INVPCID),
    CPUID_ENTRY(RTM),
    CPUID_ENTRY(CQM),
    CPUID_ENTRY(ZERO_FCS_FDS),
    CPUID_ENTRY(MPX),
    CPUID_ENTRY(RDT_A),
    CPUID_ENTRY(AVX512F),
    CPUID_ENTRY(AVX512DQ),
    CPUID_ENTRY(RDSEED),
    CPUID_ENTRY(ADX),
    CPUID_ENTRY(SMAP),
    CPUID_ENTRY(AVX512IFMA),
    CPUID_ENTRY(CLFLUSHOPT),
    CPUID_ENTRY(CLWB),
    CPUID_ENTRY(INTEL_PT),
    CPUID_ENTRY(AVX512PF),
    CPUID_ENTRY(AVX512ER),
    CPUID_ENTRY(AVX512CD),
    CPUID_ENTRY(SHA_NI),
    CPUID_ENTRY(AVX512BW),
    CPUID_ENTRY(AVX512VL),
    CPUID_ENTRY(XSAVEOPT),
    CPUID_ENTRY(XSAVEC),
    CPUID_ENTRY(XGETBV1),
    CPUID_ENTRY(XSAVES),
    CPUID_ENTRY(XFD),
    CPUID_ENTRY(CQM_LLC),
    CPUID_ENTRY(CQM_OCCUP_LLC),
    CPUID_ENTRY(CQM_MBM_TOTAL),
    CPUID_ENTRY(CQM_MBM_LOCAL),
    CPUID_ENTRY(FENCE_SWAPGS_USER),
    CPUID_ENTRY(FENCE_SWAPGS_KERNEL),
    CPUID_ENTRY(SPLIT_LOCK_DETECT),
    CPUID_ENTRY(PER_THREAD_MBA),
    CPUID_ENTRY(SGX1),
    CPUID_ENTRY(SGX2),
    CPUID_ENTRY(AVX_VNNI),
    CPUID_ENTRY(AVX512_BF16),
    CPUID_ENTRY(CLZERO),
    CPUID_ENTRY(IRPERF),
    CPUID_ENTRY(XSAVEERPTR),
    CPUID_ENTRY(RDPRU),
    CPUID_ENTRY(WBNOINVD),
    CPUID_ENTRY(AMD_IBPB),
    CPUID_ENTRY(AMD_IBRS),
    CPUID_ENTRY(AMD_STIBP),
    CPUID_ENTRY(AMD_STIBP_ALWAYS_ON),
    CPUID_ENTRY(AMD_PPIN),
    CPUID_ENTRY(AMD_SSBD),
    CPUID_ENTRY(VIRT_SSBD),
    CPUID_ENTRY(AMD_SSB_NO),
    CPUID_ENTRY(DTHERM),
    CPUID_ENTRY(IDA),
    CPUID_ENTRY(ARAT),
    CPUID_ENTRY(PLN),
    CPUID_ENTRY(PTS),
    CPUID_ENTRY(HWP),
    CPUID_ENTRY(HWP_NOTIFY),
    CPUID_ENTRY(HWP_ACT_WINDOW),
    CPUID_ENTRY(HWP_EPP),
    CPUID_ENTRY(HWP_PKG_REQ),
    CPUID_ENTRY(NPT),
    CPUID_ENTRY(LBRV),
    CPUID_ENTRY(SVML),
    CPUID_ENTRY(NRIPS),
    CPUID_ENTRY(TSCRATEMSR),
    CPUID_ENTRY(VMCBCLEAN),
    CPUID_ENTRY(FLUSHBYASID),
    CPUID_ENTRY(DECODEASSISTS),
    CPUID_ENTRY(PAUSEFILTER),
    CPUID_ENTRY(PFTHRESHOLD),
    CPUID_ENTRY(AVIC),
    CPUID_ENTRY(V_VMSAVE_VMLOAD),
    CPUID_ENTRY(VGIF),
    CPUID_ENTRY(V_SPEC_CTRL),
    CPUID_ENTRY(SVME_ADDR_CHK),
    CPUID_ENTRY(AVX512VBMI),
    CPUID_ENTRY(UMIP),
    CPUID_ENTRY(PKU),
    CPUID_ENTRY(OSPKE),
    CPUID_ENTRY(WAITPKG),
    CPUID_ENTRY(AVX512_VBMI2),
    CPUID_ENTRY(GFNI),
    CPUID_ENTRY(VAES),
    CPUID_ENTRY(VPCLMULQDQ),
    CPUID_ENTRY(AVX512_VNNI),
    CPUID_ENTRY(AVX512_BITALG),
    CPUID_ENTRY(TME),
    CPUID_ENTRY(AVX512_VPOPCNTDQ),
    CPUID_ENTRY(LA57),
    CPUID_ENTRY(RDPID),
    CPUID_ENTRY(BUS_LOCK_DETECT),
    CPUID_ENTRY(CLDEMOTE),
    CPUID_ENTRY(MOVDIRI),
    CPUID_ENTRY(MOVDIR64B),
    CPUID_ENTRY(ENQCMD),
    CPUID_ENTRY(SGX_LC),
    CPUID_ENTRY(OVERFLOW_RECOV),
    CPUID_ENTRY(SUCCOR),
    CPUID_ENTRY(SMCA),
    CPUID_ENTRY(AVX512_4VNNIW),
    CPUID_ENTRY(AVX512_4FMAPS),
    CPUID_ENTRY(FSRM),
    CPUID_ENTRY(AVX512_VP2INTERSECT),
    CPUID_ENTRY(SRBDS_CTRL),
    CPUID_ENTRY(MD_CLEAR),
    CPUID_ENTRY(RTM_ALWAYS_ABORT),
    CPUID_ENTRY(TSX_FORCE_ABORT),
    CPUID_ENTRY(SERIALIZE),
    CPUID_ENTRY(HYBRID_CPU),
    CPUID_ENTRY(TSXLDTRK),
    CPUID_ENTRY(PCONFIG),
    CPUID_ENTRY(ARCH_LBR),
    CPUID_ENTRY(AMX_BF16),
    CPUID_ENTRY(AVX512_FP16),
    CPUID_ENTRY(AMX_TILE),
    CPUID_ENTRY(AMX_INT8),
    CPUID_ENTRY(SPEC_CTRL),
    CPUID_ENTRY(INTEL_STIBP),
    CPUID_ENTRY(FLUSH_L1D),
    CPUID_ENTRY(ARCH_CAPABILITIES),
    CPUID_ENTRY(CORE_CAPABILITIES),
    CPUID_ENTRY(SPEC_CTRL_SSBD),
    CPUID_ENTRY(SME),
    CPUID_ENTRY(SEV),
    CPUID_ENTRY(VM_PAGE_FLUSH),
    CPUID_ENTRY(SEV_ES),
    CPUID_ENTRY(SME_COHERENT),
};

static const char *reg_name[] = {
    "eax", "ebx", "ecx", "edx", "lnx"
};

static state cpuid_main(struct kshell_context *ctx, int argc, char *argv[])
{
    const struct cpuid_entry *entry;
    unsigned int count;

    for (count = 0; count < ARRAY_SIZE(cpuid_table); ++count) {
        entry = cpuid_table + count;
        if (cpuid_support(entry->value))
            kshell_printf(ctx, "opcode: %#010llx reg: %-3s bit: %2lld name: %s\n",
                X86_CPUID_OP_GET(entry->value), reg_name[X86_CPUID_REG_GET(entry->value)],
                X86_CPUID_BIT_GET(entry->value), entry->name);
    }

    return -ENOERR;
}

static struct kshell_command cpuid_cmd = {
    .name = "x86-cpuid",
    .desc = "show processor cpuid",
    .exec = cpuid_main,
};

static state cpuid_init(void)
{
    return kshell_register(&cpuid_cmd);
}
kshell_initcall(cpuid_init);
